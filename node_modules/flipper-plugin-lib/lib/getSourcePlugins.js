"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getSourcePlugins = void 0;
const path_1 = __importDefault(require("path"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const expand_tilde_1 = __importDefault(require("expand-tilde"));
const pluginPaths_1 = require("./pluginPaths");
const p_map_1 = __importDefault(require("p-map"));
const p_filter_1 = __importDefault(require("p-filter"));
const semver_1 = require("semver");
const getPluginDetails_1 = require("./getPluginDetails");
const flipperVersion = require('../package.json').version;
async function getSourcePlugins() {
    const pluginFolders = await pluginPaths_1.getPluginSourceFolders();
    const entryPoints = {};
    const additionalPlugins = await p_map_1.default(pluginFolders, (path) => entryPointForPluginFolder(path));
    for (const p of additionalPlugins) {
        Object.keys(p).forEach((key) => {
            entryPoints[key] = p[key];
        });
    }
    const allPlugins = Object.values(entryPoints);
    if (process.env.FLIPPER_ENABLED_PLUGINS) {
        const pluginNames = new Set(process.env.FLIPPER_ENABLED_PLUGINS.split(',').map((x) => x.toLowerCase()));
        return allPlugins.filter((x) => pluginNames.has(x.name) ||
            pluginNames.has(x.id) ||
            pluginNames.has(x.name.replace('flipper-plugin-', '')));
    }
    return allPlugins;
}
exports.getSourcePlugins = getSourcePlugins;
async function entryPointForPluginFolder(pluginsDir) {
    pluginsDir = expand_tilde_1.default(pluginsDir);
    if (!fs_extra_1.default.existsSync(pluginsDir)) {
        return {};
    }
    return await fs_extra_1.default
        .readdir(pluginsDir)
        .then((entries) => entries.map((name) => path_1.default.join(pluginsDir, name)))
        .then((entries) => p_filter_1.default(entries, getPluginDetails_1.isPluginDir))
        .then((packages) => p_map_1.default(packages, async (dir) => {
        try {
            const details = await getPluginDetails_1.getInstalledPluginDetails(dir);
            if (details.flipperSDKVersion &&
                !semver_1.satisfies(flipperVersion, details.flipperSDKVersion)) {
                console.warn(`⚠️ The current Flipper version (${flipperVersion}) doesn't look compatible with the plugin '${details.name}', which expects 'flipper-plugin: ${details.flipperSDKVersion}'`);
            }
            return details;
        }
        catch (e) {
            console.error(`Could not load plugin from "${dir}", because package.json is invalid.`, e);
            return null;
        }
    }))
        .then((plugins) => plugins.filter(notNull))
        .then((plugins) => plugins.reduce((acc, cv) => {
        acc[cv.name] = cv;
        return acc;
    }, {}));
}
function notNull(x) {
    return x !== null && x !== undefined;
}
//# sourceMappingURL=getSourcePlugins.js.map